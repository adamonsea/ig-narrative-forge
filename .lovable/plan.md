

# AI-Generated Animation Suggestions

## Overview

Add intelligent, context-aware animation suggestions generated by GPT-4o-mini during image creation. Suggestions will be displayed in the animation modal with a sparkle icon (âœ¨) to indicate they're AI-generated, with a subtle "typing" effect for delight.

---

## Cost Analysis

### Per-Image AI Suggestion Cost

| Component | Value |
|-----------|-------|
| Model | `gpt-4o-mini` |
| Input tokens | ~100 tokens (prompt + context) |
| Output tokens | ~60 tokens (4 suggestions) |
| Input cost | $0.00015/1K tokens |
| Output cost | $0.0006/1K tokens |
| **Total per image** | **~$0.00005** (5/100ths of a cent) |

### At Scale

| Volume | Monthly Cost |
|--------|--------------|
| 100 images/month | $0.005 (~half a penny) |
| 1,000 images/month | $0.05 (~5 cents) |
| 10,000 images/month | $0.50 (~50 cents) |

**Negligible cost impact.** The existing image generation ($0.01-$0.20) dwarfs this.

### Latency Impact
- Adds ~300-500ms to image generation
- Runs **after** image upload completes (non-blocking)
- User won't notice since they're already waiting for the main generation

---

## Implementation Plan

### 1. Database Migration

Add column to store AI-generated suggestions:

```sql
ALTER TABLE stories 
ADD COLUMN animation_suggestions TEXT[] DEFAULT NULL;

COMMENT ON COLUMN stories.animation_suggestions IS 
  'AI-generated animation motion suggestions for the cover illustration';
```

---

### 2. Edge Function Update: `story-illustrator`

Add a new helper function after image generation succeeds:

```typescript
/**
 * Generate context-aware animation suggestions using GPT-4o-mini
 * Cost: ~$0.00005 per call (negligible)
 */
async function generateAnimationSuggestions(
  subjectMatter: string,
  storyTitle: string,
  openaiKey: string
): Promise<string[]> {
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openaiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{
          role: 'user',
          content: `Given this editorial illustration subject, suggest exactly 4 subtle animation movements for a 5-second cinemagraph.

SUBJECT: ${subjectMatter}
HEADLINE: ${storyTitle}

RULES:
- Each suggestion: 3-5 words maximum
- Focus on MOTION only (what moves, how)
- Subtle, looping movements
- One for main subject, one for environment

Return ONLY a JSON array of 4 strings.`
        }],
        max_tokens: 80,
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      console.warn('Animation suggestions API error, skipping');
      return [];
    }

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content || '[]';
    return JSON.parse(content);
  } catch (error) {
    console.warn('Animation suggestions failed (non-critical):', error);
    return []; // Graceful fallback
  }
}
```

**Update the database save (around line 1411-1419):**

```typescript
// Generate animation suggestions (non-blocking, cheap)
const animationSuggestions = await generateAnimationSuggestions(
  subjectMatter,
  story.title || story.headline || '',
  OPENAI_API_KEY
);

// Update story with illustration + suggestions
const { error: updateError } = await supabase
  .from('stories')
  .update({
    cover_illustration_url: imageUrl,
    cover_illustration_prompt: illustrationPrompt,
    illustration_generated_at: new Date().toISOString(),
    animated_illustration_url: null,
    animation_suggestions: animationSuggestions.length > 0 ? animationSuggestions : null
  })
  .eq('id', storyId)
```

---

### 3. Frontend: AnimationInstructionsModal Update

**Add sparkle icon import and update interface:**

```typescript
import { Loader2, Sparkles } from 'lucide-react';

interface AnimationInstructionsModalProps {
  story: {
    id: string;
    headline?: string;
    title?: string;
    cover_illustration_url?: string | null;
    cover_illustration_prompt?: string | null;
    tone?: string | null;
    animation_suggestions?: string[] | null;  // NEW
  } | null;
  // ... rest unchanged
}
```

**Update suggestions logic to prefer AI-generated:**

```typescript
const suggestions = useMemo(() => {
  if (!story) return [];
  
  // Prefer AI-generated suggestions from database
  if (story.animation_suggestions && story.animation_suggestions.length > 0) {
    return story.animation_suggestions;
  }
  
  // Fallback to regex-based for legacy images
  return generateSuggestions({
    cover_illustration_prompt: story.cover_illustration_prompt,
    headline: story.headline,
    title: story.title,
    tone: story.tone,
  });
}, [story?.id, story?.animation_suggestions, story?.cover_illustration_prompt, ...]);

// Determine if showing AI suggestions
const isAiGenerated = story?.animation_suggestions && story.animation_suggestions.length > 0;
```

**Update UI with sparkle icon:**

```tsx
{/* Suggestions with AI indicator */}
<div className="space-y-2">
  {isAiGenerated && (
    <div className="flex items-center gap-1.5 text-xs text-muted-foreground">
      <Sparkles className="w-3.5 h-3.5 text-amber-500" />
      <span>AI-suggested for this image</span>
    </div>
  )}
  <div className="flex flex-wrap gap-2">
    {suggestions.map((suggestion) => (
      <Badge
        key={suggestion}
        variant={customPrompt === suggestion ? 'default' : 'outline'}
        className="cursor-pointer hover:bg-primary/10 transition-colors"
        onClick={() => handleSuggestionClick(suggestion)}
      >
        {suggestion}
      </Badge>
    ))}
  </div>
</div>
```

---

### 4. Update Story Queries

**In `MultiTenantStoriesList.tsx`**, add `animation_suggestions` to the select query wherever stories are fetched for the animation modal.

---

## Visual Design

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Animate Illustration                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚      Guide the motion, not the meaning.      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                              â”‚
â”‚  âœ¨ AI-suggested for this image              â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Baby wiggles in â”‚ â”‚ Parents smile    â”‚   â”‚
â”‚  â”‚ parent's arms   â”‚ â”‚ softly           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Midwife's badge â”‚ â”‚ Hospital light   â”‚   â”‚
â”‚  â”‚ catches light   â”‚ â”‚ flickers         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Or describe what should move...        â”‚ â”‚
â”‚  â”‚                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  Leave empty for auto                 0/200 â”‚
â”‚                                              â”‚
â”‚  Cost: 2 credits              Balance: 47   â”‚
â”‚                                              â”‚
â”‚              [Cancel]  [ğŸ¬ Animate]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Files to Modify

| File | Change |
|------|--------|
| `supabase/migrations/` | Add `animation_suggestions TEXT[]` column |
| `supabase/functions/story-illustrator/index.ts` | Add `generateAnimationSuggestions()`, update DB save |
| `src/components/topic-pipeline/AnimationInstructionsModal.tsx` | Add Sparkles icon, prefer DB suggestions, show AI indicator |
| `src/components/topic-pipeline/MultiTenantStoriesList.tsx` | Add `animation_suggestions` to story query |

---

## Fallback Strategy

1. **New images**: Get AI-generated suggestions stored in DB
2. **Legacy images** (no suggestions in DB): Fall back to existing regex matching
3. **AI call failure**: Gracefully skip, save `null` - regex fallback handles it

---

## Summary

- **Cost**: Negligible (~$0.00005 per image, <$1/month at scale)
- **Latency**: ~400ms added post-upload (not noticeable)
- **UX**: Sparkle icon indicates AI-generated suggestions
- **Reliability**: Graceful fallback to regex for any failures

