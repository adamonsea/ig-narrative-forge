
# Plan: Add 4-Hour Scrape Frequency + Fix Full Automation Pipeline

## Overview
Two changes are needed:
1. Add a 4-hour frequency option to the scraping settings
2. Fix the full automation pipeline that isn't triggering auto-simplification

---

## Part 1: Add 4-Hour Frequency Option

### What we'll change
- Update the scrape frequency slider to start at 4 hours instead of 6
- Change step size from 6 to 4 for more granular control

### File to modify
`src/components/TopicAutomationSettings.tsx`

Current settings (lines 243-245):
- min: 6, max: 24, step: 6
- Available: 6h, 12h, 18h, 24h

New settings:
- min: 4, max: 24, step: 4
- Available: 4h, 8h, 12h, 16h, 20h, 24h

---

## Part 2: Fix Full Automation Pipeline

### Root Causes Identified

1. **Conflicting settings locations**
   - The `topics` table has `auto_simplify_enabled: true`
   - The `topic_automation_settings` table has `auto_simplify_enabled: false`
   - The automation functions check `topic_automation_settings`, so auto-simplify never triggers

2. **Disabled orchestrator**
   - `eezee-automation-service` is commented out in config.toml (it was causing articles to be auto-discarded)
   - This was the main function that orchestrated the full pipeline

3. **Mode mismatch**
   - Eastbourne is set to `auto_gather` mode only
   - For full automation, it should be `holiday` mode (which does gather + simplify + illustrate)

### Fixes to implement

**Fix A: Synchronize settings when saving automation mode**
When a user selects `holiday` mode (full automation), ensure `auto_simplify_enabled` and `auto_illustrate_enabled` are set to `true` in `topic_automation_settings`.

File: `src/components/TopicAutomationSettings.tsx`
- Already does this partially on line 95-96, but we should verify it saves correctly

**Fix B: Update `auto-simplify-queue` to also check `automation_mode`**
The function should queue articles for topics where:
- `automation_mode = 'holiday'` OR
- `automation_mode = 'auto_simplify'` OR  
- `auto_simplify_enabled = true`

File: `supabase/functions/auto-simplify-queue/index.ts`
- Already does this on line 40: `.or('automation_mode.eq.auto_simplify,auto_simplify_enabled.eq.true')`
- Need to add `automation_mode.eq.holiday` to the filter

**Fix C: Create a unified topic automation cron**
Since `eezee-automation-service` is disabled, we need to create a lightweight cron job that:
1. Calls `universal-topic-automation` for topics with `auto_gather` or `holiday` mode
2. The existing `auto-simplify-queue` cron (every 10 mins) will handle the simplification step

This requires adding a new cron job via SQL to call `universal-topic-automation` periodically.

---

## Technical Summary

### Files to Modify
| File | Change |
|------|--------|
| `src/components/TopicAutomationSettings.tsx` | Update slider min/step to 4 |
| `supabase/functions/auto-simplify-queue/index.ts` | Add `holiday` mode to filter |

### Database Changes (via Supabase SQL)
- Add cron job to trigger `universal-topic-automation` every 2 hours

### What the fix enables
After these changes:
1. Users can set 4-hour scrape intervals
2. Topics in `holiday` mode will:
   - Get scraped automatically by the new cron
   - Have articles auto-queued for simplification by `auto-simplify-queue`
   - Stories will be generated by `queue-processor` (already runs)

---

## Expected Outcome
- Eastbourne (and other topics) with `holiday` mode will have full end-to-end automation
- More granular scrape frequency options (4h, 8h, 12h, 16h, 20h, 24h)
